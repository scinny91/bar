{% extends 'bar/base.html' %}
{% load dict_extras %} {# serve per dict_get #}
{% block content %}
<div class="container-fluid mt-4">
  <h2 class="text-center">{{ titolo_pagina }}</h2>

  <form method="post">
    {% csrf_token %}
    {% regroup prodotti by categoria as prodotti_per_categoria %}

    {% for categoria_group in prodotti_per_categoria %}
      <h4 class="mt-4">{{ categoria_group.grouper }}</h4>

      {% regroup categoria_group.list by sottocategoria as prodotti_per_sottocategoria %}
      {% for sottocategoria_group in prodotti_per_sottocategoria %}
        <h5 class="ms-2">{{ sottocategoria_group.grouper }}</h5>

        {% for prodotto in sottocategoria_group.list %}
          <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ prodotto.nome }}</strong><br>
                <small class="text-muted">€{{ prodotto.prezzo }}</small>
              </div>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="aggiungiRiga({{ prodotto.id }})">+</button>
            </div>

            <div id="prodotto-{{ prodotto.id }}-container" class="mt-2">
              {% for riga in prodotto.righe %}
              <div class="row gx-2 gy-2 align-items-center mb-2">
                <div class="col-4">
                  <input value="{{ riga.quantita }}" type="number" name="qty_{{ prodotto.id }}[]" min="0" class="form-control" placeholder="Qtà">
                </div>
                <div class="col-8">
                  <select name="opt_{{ prodotto.id }}[]" class="form-select">
                    {% for value, label in opzioni %}
                      <option value="{{ value }}" {% if riga.opzioni.chiave == value %} selected {% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    {% endfor %}

    <div class="mt-4 d-grid gap-2">
      <input
        type="text"
        name="nome_ordine"
        placeholder="Nome Ordine"
        class="form-control"
        value="{{ nome_ordine|default:'' }}"
        required
      />

      <div class="d-flex justify-content-between gap-2">
        <a href="{% url 'lista_ordini' %}" class="btn btn-secondary w-50">Annulla</a>
        <button type="submit" class="btn btn-primary w-50">
          {{ bottone_submit|default:"Salva Ordine" }}
        </button>
      </div>
    </div>
  </form>
</div>
<script>
    function aggiungiRiga(prodottoId) {
      const container = document.getElementById(`prodotto-${prodottoId}-container`);
      console.log('add row')
      const row = document.createElement('div');
      row.className = 'row gy-2 mb-2';

      row.innerHTML = `
        <div class="col-4">
          <input type="number" name="qty_${prodottoId}[]" min="0" class="form-control" placeholder="Quantità">
        </div>
        <div class="col-6">
          <select name="opt_${prodottoId}[]" class="form-control">
            {% for value, label in opzioni %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-2">
          <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()">−</button>
        </div>
      `;

      container.appendChild(row);
    }
    </script>


{% endblock %}

